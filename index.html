<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Podcast</title>
    <link rel="manifest" href="manifest.json">
    <meta id="theme-meta" name="theme-color" content="#f2f2f7">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'><defs><linearGradient id='podGradient' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%23AF52FF;stop-opacity:1' /><stop offset='100%' style='stop-color:%235C5CFF;stop-opacity:1' /></linearGradient></defs><rect width='200' height='200' rx='45' fill='url(%23podGradient)'/><g fill='white'><rect x='55' y='85' width='12' height='30' rx='6' opacity='0.6'/><rect x='75' y='70' width='12' height='60' rx='6' opacity='0.8'/><rect x='95' y='55' width='12' height='90' rx='6'/><rect x='115' y='70' width='12' height='60' rx='6' opacity='0.8'/><rect x='135' y='85' width='12' height='30' rx='6' opacity='0.6'/></g></svg>">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/player.css">
</head>
<body>
    <div class="inline-header">
        <div class="header-left">
            <div class="brand-wrapper" onclick="location.reload()">
                <div class="brand-icon-pro">
                    <svg viewBox="0 0 100 100"><rect width="100" height="100" rx="22" fill="url(#headerGrad)"/><defs><linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#AF52FF"/><stop offset="100%" style="stop-color:#5C5CFF"/></linearGradient></defs><g fill="white"><rect x="30" y="45" width="8" height="20" rx="4" opacity="0.6"/><rect x="45" y="35" width="8" height="40" rx="4"/><rect x="60" y="45" width="8" height="20" rx="4" opacity="0.6"/></g></svg>
                </div>
                <span class="brand-text">Podcast</span>
            </div>
        </div>
        <div class="header-right">
            <button id="themeToggle" class="icon-btn-circle" title="ÂàáÊç¢‰∏ªÈ¢ò">üåì</button>
            <button id="editBtn" class="icon-btn-circle">ÁºñËæë</button>
            <button class="icon-btn-circle" onclick="document.getElementById('rssFileInput').click()">Ôºã</button>
        </div>
    </div>

    <input type="file" id="rssFileInput" accept=".json" style="display:none">

    <main id="podcastGrid" class="podcast-grid"></main>

    <div id="episodeListOverlay" class="episodes-list">
        <div class="list-header">
            <button class="back-btn" onclick="closeEpisodeList()">‚úï</button>
            <h2 id="listTitle" class="list-header-title">ÂçïÈõÜÂàóË°®</h2>
        </div>
        <div id="epListScroll" class="scroll-area"></div>
    </div>

    <div id="playerOverlay" class="player-overlay"></div>

    <script type="module">
        import { PlayerCore } from './js/player-core.js';
        import { UI } from './js/ui-controller.js';

        // Áä∂ÊÄÅÊ†è‰∏é‰∏ªÈ¢òÂêåÊ≠•ÂàáÊç¢ÈÄªËæë
        window.updateThemeUI = function(isDark) {
            const themeMeta = document.getElementById('theme-meta');
            if (isDark) {
                document.body.classList.add('dark-mode');
                if(themeMeta) themeMeta.setAttribute('content', '#000000');
                localStorage.setItem('podcast_theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                if(themeMeta) themeMeta.setAttribute('content', '#f2f2f7');
                localStorage.setItem('podcast_theme', 'light');
            }
        };

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    const list = JSON.parse(localStorage.getItem('my_podcasts') || '[]');
                    list.push(data);
                    localStorage.setItem('my_podcasts', JSON.stringify(list));
                    renderPodcastList();
                } catch(err) { alert('JSON Ê†ºÂºèÈîôËØØÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂ÂÜÖÂÆπ'); }
            };
            reader.readAsText(file);
        }

        window.removePodcast = (index, e) => {
            e.stopPropagation();
            if(!confirm('Á°ÆÂÆö‰ªéÂ∫ì‰∏≠ÁßªÈô§Ê≠§Êí≠ÂÆ¢ÂêóÔºü')) return;
            const list = JSON.parse(localStorage.getItem('my_podcasts') || '[]');
            list.splice(index, 1);
            localStorage.setItem('my_podcasts', JSON.stringify(list));
            renderPodcastList();
        };

        window.showEpisodeList = (index) => {
            const list = JSON.parse(localStorage.getItem('my_podcasts') || '[]');
            const podcast = list[index];
            document.getElementById('listTitle').innerText = podcast.title;
            const container = document.getElementById('epListScroll');
            container.innerHTML = podcast.episodes.map(ep => `
                <div class="ep-item" onclick='playEpisode(${JSON.stringify(ep).replace(/'/g, "&apos;")}, "${podcast.title}", "${podcast.image}")'>
                    <img class="ep-list-cover" src="${ep.image || podcast.image}">
                    <div class="ep-list-info">
                        <div class="ep-list-title">${ep.title}</div>
                        <div class="ep-list-meta">Á´ãÂç≥Êí≠Êîæ</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('episodeListOverlay').classList.add('is-active');
        };

        window.closeEpisodeList = () => {
            document.getElementById('episodeListOverlay').classList.remove('is-active');
        };

        window.playEpisode = (ep, pTitle, pCover) => {
            UI.openPlayer(ep, pTitle, pCover);
        };

        function renderPodcastList() {
            const grid = document.getElementById('podcastGrid');
            const list = JSON.parse(localStorage.getItem('my_podcasts') || '[]');
            grid.innerHTML = list.map((p, i) => `
                <div class="podcast-card" onclick="showEpisodeList(${i})">
                    <div class="delete-badge" onclick="removePodcast(${i}, event)">‚àí</div>
                    <div class="card-cover-wrapper">
                        <img src="${p.image}" loading="lazy">
                    </div>
                    <div class="card-content">
                        <div class="card-title">${p.title}</div>
                        <div class="card-author">${p.author}</div>
                    </div>
                </div>
            `).join('');
            const spacer = document.createElement('div');
            spacer.className = 'grid-footer-spacer';
            grid.appendChild(spacer);
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderPodcastList();
            PlayerCore.onStatusChange((isPlaying) => window.updatePlayIcons(isPlaying));
            
            const savedTheme = localStorage.getItem('podcast_theme');
            if (savedTheme === 'dark') updateThemeUI(true);

            document.getElementById('themeToggle').onclick = () => {
                const isDark = document.body.classList.contains('dark-mode');
                updateThemeUI(!isDark);
            };

            const fileInput = document.getElementById('rssFileInput');
            if(fileInput) fileInput.onchange = handleFileUpload;
            
            const editBtn = document.getElementById('editBtn');
            if(editBtn) editBtn.onclick = (e) => { 
                e.stopPropagation(); 
                document.body.classList.toggle('edit-mode'); 
            };

            const range = document.getElementById('progressRange');
            if(range) range.oninput = (e) => PlayerCore.seek(e.target.value);

            PlayerCore.onTimeUpdate((pct, cur, tot) => {
                const f = document.getElementById('miniProgressFill');
                if(f) f.style.width = pct + '%';
                const pr = document.getElementById('progressRange');
                if(pr) pr.value = pct;
                const ct = document.getElementById('currentTime');
                if(ct) ct.innerText = cur;
                const dt = document.getElementById('durationTime');
                if(dt) dt.innerText = tot;
            });
        });
    </script>
</body>
</html>
