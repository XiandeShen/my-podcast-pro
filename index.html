<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Podcast Pro</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'><defs><linearGradient id='podGradient' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%23AF52FF;stop-opacity:1' /><stop offset='100%' style='stop-color:%235C5CFF;stop-opacity:1' /></linearGradient></defs><rect width='200' height='200' rx='45' fill='url(%23podGradient)'/><g fill='white'><rect x='55' y='85' width='12' height='30' rx='6' opacity='0.6'/><rect x='75' y='70' width='12' height='60' rx='6' opacity='0.8'/><rect x='95' y='55' width='12' height='90' rx='6'/><rect x='115' y='70' width='12' height='60' rx='6' opacity='0.8'/><rect x='135' y='85' width='12' height='30' rx='6' opacity='0.6'/></g></svg>">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/player.css">
    <style>
        .inline-header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; height: 30px; }
        .header-left .brand-wrapper { display: flex; align-items: center; gap: 12px; cursor: pointer; transition: transform 0.2s ease; }
        .header-left .brand-wrapper:active { transform: scale(0.96); }
        .brand-icon-pro { width: 32px; height: 32px; }
        #brandTitle { font-size: 24px; font-weight: 800; margin: 0; }
        .header-actions { display: flex; gap: 8px; position: relative; }
        .dropdown-menu {
            position: absolute; top: 45px; right: 0; background: var(--menu-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); width: 160px; display: none; flex-direction: column; padding: 6px; z-index: 2000;
            border: 0.5px solid var(--border-light); animation: menuFade 0.2s ease-out;
        }
        @keyframes menuFade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .dropdown-menu.show { display: flex; }
        .menu-item { display: flex; align-items: center; gap: 10px; padding: 12px 14px; font-size: 14px; font-weight: 500; color: var(--text-main); border-radius: 10px; cursor: pointer; }
        .menu-item:active { background: rgba(120,120,120,0.1); }
        .menu-divider { height: 0.5px; background: var(--border-light); margin: 4px 8px; }
    </style>
</head>
<body>
    <audio id="main-audio-player" preload="metadata" style="display: none;"></audio>

    <div class="app-container">
        <section class="main-layout" id="scrollContainer">
            <main class="content" id="mainGrid">
                <div class="inline-header">
                    <div class="header-left">
                        <div class="brand-wrapper" onclick="location.reload()">
                            <div class="brand-icon-pro">
                                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                                    <defs><linearGradient id="pgH" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#AF52FF"/><stop offset="100%" style="stop-color:#5C5CFF"/></linearGradient></defs>
                                    <rect width="200" height="200" rx="45" fill="url(#pgH)"/><g fill="white"><rect x="55" y="85" width="12" height="30" rx="6" opacity="0.6"/><rect x="75" y="70" width="12" height="60" rx="6" opacity="0.8"/><rect x="95" y="55" width="12" height="90" rx="6"/><rect x="115" y="70" width="12" height="60" rx="6" opacity="0.8"/><rect x="135" y="85" width="12" height="30" rx="6" opacity="0.6"/></g>
                                </svg>
                            </div>
                            <h1 id="brandTitle">PODCAST</h1>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="action-btn" id="editBtn"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>
                        <div style="position: relative;">
                            <button class="action-btn" id="menuToggleBtn"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></button>
                            <div class="dropdown-menu" id="moreMenu">
                                <div class="menu-item" id="importAction">添加节目</div>
                                <div class="menu-item" id="exportAction">备份资料库</div>
                                <div class="menu-divider"></div>
                                <div class="menu-item" id="themeToggleAction"><span id="themeText">深色模式</span></div>
                            </div>
                        </div>
                        <input type="file" id="rssFileInput" accept=".rss,.xml,.json" multiple style="display:none">
                    </div>
                </div>
            </main>

            <footer class="mini-player is-empty" id="miniPlayer" onclick="window.expandPlayer()">
                <div class="mini-player-content">
                    <div class="mini-info">
                        <img id="miniCover" src="data:image/svg+xml,<svg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'><rect width='200' height='200' fill='%23ccc'/></svg>">
                        <div class="mini-text"><div id="miniTitle">请选择节目</div><div id="miniAuthor">PODCAST</div></div>
                    </div>
                    <div class="mini-controls">
                        <button class="mini-play-btn" id="miniPlayBtn" onclick="event.stopPropagation(); window.handleToggle()">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <button class="mini-speed-btn-text" id="miniSpeedBtn" onclick="event.stopPropagation(); window.toggleSpeed()">1.0x</button>
                    </div>
                </div>
                <div class="mini-progress-bar"><div class="mini-progress-fill" id="miniProgressFill"></div></div>
            </footer>
        </section>
    </div>

    <div id="playerOverlay" class="p-overlay">
        <div id="dynamicBg" class="p-dynamic-bg"></div>
        <div class="p-header-nav">
            <button class="p-close-btn" onclick="window.closePlayer()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="3.5"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
        <div class="p-main-content">
            <div class="p-cover-wrap"><img id="playerCover" src=""></div>
            <div class="p-controls-area">
                <div class="p-info-stack"><h2 id="playerTitle">未播放</h2><p id="playerAuthor">作者</p></div>
                <div class="p-progress-wrap">
                    <input type="range" class="p-slider" value="0" id="progressRange">
                    <div class="p-time-info"><span id="currentTime">0:00</span><span id="durationTime">0:00</span></div>
                </div>
                <div class="p-controls">
                    <button class="p-btn-sec" onclick="window.seekOffset(-15)"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/><text x="12" y="15.5" font-size="7" font-weight="900" text-anchor="middle" fill="currentColor" stroke="none">15</text></svg></button>
                    <button class="p-btn-play-large" id="mainPlayBtn" onclick="window.handleToggle()"><svg viewBox="0 0 24 24" width="40" height="40" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
                    <button class="p-btn-sec" onclick="window.seekOffset(15)"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/><text x="12" y="15.5" font-size="7" font-weight="900" text-anchor="middle" fill="currentColor" stroke="none">15</text></svg></button>
                </div>
                <div class="p-sub-actions">
                    <button class="p-action-pill" id="fullSpeedBtn" onclick="window.toggleSpeed()">1.0x</button>
                    <button class="p-action-pill" id="markDoneBtn" onclick="window.toggleCurrentEpisodeDone()">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="3.5" style="margin-right:4px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <span>已听</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="episodeModalOverlay" class="modal-overlay" onclick="window.closeModal()">
        <div class="episode-modal" onclick="event.stopPropagation()">
            <div class="modal-header"><h3 id="modalPodTitle">节目列表</h3><button class="modal-close-x" onclick="window.closeModal()">&times;</button></div>
            <div id="modalEpisodeList" class="modal-content"></div>
        </div>
    </div>

    <script type="module">
        import { PlayerCore } from './js/player-core.js';
        
        let allPodcastsData = [];
        try { allPodcastsData = JSON.parse(localStorage.getItem('podcast_db') || '[]'); } catch(e) { allPodcastsData = []; }

        const speeds = [1.0, 1.25, 1.5, 2.0];
        let currentSpeedIndex = 0;
        let currentPlayingIdx = { pod: -1, ep: -1 };
        window.isDraggingRange = false; 

        // 菜单与UI基础逻辑
        const moreMenu = document.getElementById('moreMenu');
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        menuToggleBtn.onclick = (e) => { e.stopPropagation(); moreMenu.classList.toggle('show'); };
        document.addEventListener('click', () => moreMenu.classList.remove('show'));

        document.getElementById('importAction').onclick = () => document.getElementById('rssFileInput').click();
        document.getElementById('themeToggleAction').onclick = () => {
            const isDark = !document.body.classList.contains('dark-mode');
            document.body.classList.toggle('dark-mode', isDark);
            document.getElementById('themeText').innerText = isDark ? '浅色模式' : '深色模式';
            localStorage.setItem('podcast_theme', isDark ? 'dark' : 'light');
        };

        window.expandPlayer = () => {
            if (document.getElementById('miniPlayer').classList.contains('is-empty')) return;
            document.getElementById('playerOverlay').classList.add('is-active');
        };
        window.closePlayer = () => document.getElementById('playerOverlay').classList.remove('is-active');
        window.closeModal = () => document.getElementById('episodeModalOverlay').style.display = 'none';

        // 播放控制
        window.handleToggle = () => {
            if (!PlayerCore.audio.src || PlayerCore.audio.src === window.location.href) return;
            const isPlaying = PlayerCore.toggle();
            window.updatePlayIcons(isPlaying);
        };

        window.toggleSpeed = () => {
            currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
            const ns = speeds[currentSpeedIndex];
            PlayerCore.audio.playbackRate = ns;
            document.getElementById('miniSpeedBtn').innerText = ns.toFixed(1) + 'x';
            document.getElementById('fullSpeedBtn').innerText = ns.toFixed(1) + 'x';
        };

        window.seekOffset = (s) => PlayerCore.seekOffset(s);

        window.updatePlayIcons = (isPlaying) => {
            const pSvg = '<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            const sSvg = '<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            document.getElementById('miniPlayBtn').innerHTML = isPlaying ? sSvg : pSvg;
            document.getElementById('mainPlayBtn').innerHTML = isPlaying ? sSvg.replace(/22/g, '40') : pSvg.replace(/22/g, '40');
        };

        window.toggleCurrentEpisodeDone = () => {
            const { pod, ep } = currentPlayingIdx;
            if(pod === -1) return;
            const item = allPodcastsData[pod].episodes[ep];
            item.isFinished = !item.isFinished;
            document.getElementById('markDoneBtn').classList.toggle('is-active', item.isFinished);
            localStorage.setItem('podcast_db', JSON.stringify(allPodcastsData));
        };

        window.renderEpisodeList = (podIdx) => {
            const p = allPodcastsData[podIdx];
            const listContainer = document.getElementById('modalEpisodeList');
            document.getElementById('modalPodTitle').innerText = p.title;
            listContainer.innerHTML = "";
            document.getElementById('episodeModalOverlay').style.display = 'flex';

            p.episodes.forEach((ep, epIdx) => {
                const item = document.createElement('div');
                item.className = `episode-list-item ${ep.isFinished ? 'is-finished' : ''}`;
                item.onclick = () => {
                    currentPlayingIdx = { pod: podIdx, ep: epIdx };
                    const cover = ep.image || p.image;
                    document.getElementById('miniPlayer').classList.remove('is-empty');
                    document.getElementById('miniCover').src = cover;
                    document.getElementById('miniTitle').innerText = ep.title;
                    document.getElementById('miniAuthor').innerText = p.title;
                    document.getElementById('playerCover').src = cover;
                    document.getElementById('playerTitle').innerText = ep.title;
                    document.getElementById('playerAuthor').innerText = p.title;
                    document.getElementById('dynamicBg').style.backgroundImage = `url('${cover}')`;
                    document.getElementById('markDoneBtn').classList.toggle('is-active', !!ep.isFinished);
                    
                    PlayerCore.updateMetadata(ep.title, p.title, cover);
                    PlayerCore.play(ep.audioUrl);
                    PlayerCore.audio.playbackRate = speeds[currentSpeedIndex];
                    window.updatePlayIcons(true);
                };
                item.innerHTML = `<img class="ep-list-cover" src="${ep.image || p.image}"><div class="ep-list-info"><div class="ep-list-title">${ep.title}</div><div class="ep-list-meta">${ep.isFinished ? '已听完' : '等待播放'}</div></div>`;
                listContainer.appendChild(item);
            });
        };

        // 文件处理
        async function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            for (const file of files) {
                const text = await file.text();
                const dom = new DOMParser().parseFromString(text, "text/xml");
                const channel = dom.querySelector("channel");
                if (!channel) continue;
                const getImg = (el) => {
                    const i = el.getElementsByTagName("itunes:image")[0];
                    return i ? i.getAttribute("href") : (el.querySelector("image > url")?.textContent || "");
                };
                const pod = {
                    title: channel.querySelector("title")?.textContent || "未知播客",
                    author: channel.querySelector("itunes\\:author, author")?.textContent || "未知作者",
                    image: getImg(channel),
                    episodes: Array.from(dom.querySelectorAll("item")).map(item => ({
                        title: item.querySelector("title")?.textContent,
                        audioUrl: item.querySelector("enclosure")?.getAttribute("url"),
                        image: getImg(item) || getImg(channel),
                        isFinished: false 
                    }))
                };
                allPodcastsData.push(pod);
            }
            localStorage.setItem('podcast_db', JSON.stringify(allPodcastsData));
            renderPodcastList();
        }

        function renderPodcastList() {
            const grid = document.getElementById('mainGrid');
            grid.querySelectorAll('.podcast-card').forEach(c => c.remove());
            allPodcastsData.forEach((p, i) => {
                const card = document.createElement('div');
                card.className = 'podcast-card';
                card.style.setProperty('--card-cover', `url('${p.image}')`);
                card.onclick = () => window.renderEpisodeList(i);
                card.innerHTML = `<div class="card-inner"><div class="card-info"><h3>${p.title}</h3><p>${p.author}</p></div></div>`;
                grid.appendChild(card);
            });
        }

        // 初始化与播放器同步
        document.addEventListener('DOMContentLoaded', () => {
            renderPodcastList();
            if (localStorage.getItem('podcast_theme') === 'dark') document.body.classList.add('dark-mode');
            document.getElementById('rssFileInput').onchange = handleFileUpload;

            const range = document.getElementById('progressRange');
            if(range) {
                range.oninput = (e) => {
                    const target = (e.target.value / 100) * PlayerCore.audio.duration;
                    document.getElementById('currentTime').innerText = PlayerCore.format(target);
                };
                range.onchange = (e) => PlayerCore.seek(e.target.value);
                range.addEventListener('touchstart', () => window.isDraggingRange = true);
                range.addEventListener('touchend', () => window.isDraggingRange = false);
            }

            PlayerCore.onTimeUpdate((pct, cur, tot) => {
                document.getElementById('miniProgressFill').style.width = pct + '%';
                if(!window.isDraggingRange) {
                    document.getElementById('progressRange').value = pct;
                    document.getElementById('currentTime').innerText = cur;
                    document.getElementById('durationTime').innerText = tot;
                }
            });

            PlayerCore.audio.onended = () => {
                window.updatePlayIcons(false);
                if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "none";
            };
        });
    </script>
</body>
</html>
